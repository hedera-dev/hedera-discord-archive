# Signature verification

Original conversation link: <https://discord.com/channels/373889138199494658/1428310484670746694/1428310484670746694>

## Message 1428310484670746694

By @ØDemer (rusty00407#0 891622512121774101)
at *2025-10-16 09:15:56.271 UTC*

```txt
Hi team,

I'm having trouble verifying an off-ledger message signature generated by the HashPack wallet (connected via WalletConnect/Hashgraph-React-Wallets). The verification consistently fails (isValid is false). I believe the issue is with recreating the exact prefix that HashPack adds to the message.

I am verifying the signature on the backend using the @hashgraph/sdk's PublicKey.verify() method.
```

## Message 1428313018193674252

By @ØDemer (rusty00407#0 891622512121774101)
at *2025-10-16 09:26:00.310 UTC*
**MODIFIED** last time at *2025-10-16 09:28:15.656 UTC*

````txt
My backend code

```ts
async verifySignature(
  publicKey: string,
  accountId: string,
  message: string,
  signature: string,
): Promise<{ token: string }> {
  const publicKeyBytes = Buffer.from(publicKey, 'base64');
  const signatureBytes = Buffer.from(signature, 'base64');
  const pubKey = PublicKey.fromBytesED25519(publicKeyBytes);

  const prefix = '\x19Hedera Signed Message:\n';
  const messageToVerify = prefix + message.length + message;
  const messageBytes = Buffer.from(messageToVerify, 'utf8');

  const isValid = pubKey.verify(messageBytes, signatureBytes);
  console.log('Verified:', isValid);

  if (!isValid) {
    throw httpErrors.unauthorized("Invalid Hedera signature");
  }

  const evmAddress = this.accountIdToSolidityAddress(accountId);
  const investor = await investorService.connectWallet(accountId, {
    network: 'hedera',
    evmAddress,
  });

  const token = this.app.jwt.sign({
    investorId: (investor as any)._id,
    role: 'investor',
    accountId,
  });

  return { token };
}
```
````

## Message 1428314072876585071

By @ØDemer (rusty00407#0 891622512121774101)
at *2025-10-16 09:30:11.766 UTC*

````txt
My frontend code

```ts
import {
  useAuthSignature,
  UserRefusedToSignAuthError,
} from "@buidlerlabs/hashgraph-react-wallets";

 const { signAuth } = useAuthSignature();
  const [loading, setLoading] = useState(false);
  const handleAuthenticate = async () => {
    try {
      setLoading(true);
      const nonce = await getNonce(accountId);
      const message = nonce;
      const signerSignature = await signAuth("Hello");
      const signatureBytes = getBytes(signerSignature.signature);
      const publicKey = signerSignature.publicKey;
      const publicKeyBytes = publicKey.toBytes();

      const payload = {
        message: "Hello",
        publicKey: Buffer.from(publicKeyBytes).toString("base64"),
        signature: Buffer.from(signatureBytes).toString("base64"),
        accountId,
      };

      const result = await authenticateUser(payload);
      sessionStorage.setItem("accessToken", result);

      toast.success("Authenticated successfully :tada:");
      onOpenChange(false);
    } catch (error: any) {
      if (error instanceof UserRefusedToSignAuthError) {
        toast.error("Sign in failed :dotted_line_face:");
      } else {
        toast.error(error.response?.data?.message || "Something went wrong");
      }
    } finally {
      setLoading(false);
    }
  };
```
````

## Message 1428315035079278716

By @Luke Forrest (lukeforrest_hashgraph#0 1396895843923005653)
at *2025-10-16 09:34:01.173 UTC*

```txt
Hey, so the package that you are using may not be maintained anymore, I cannot see any activity on that repo since March 13th, it will be worth looking at https://docs.hedera.com/hedera/tutorials/more-tutorials/develop-a-hedera-dapp-integrated-with-walletconnect
```

## Message 1428417212531740864

By @ØDemer (rusty00407#0 891622512121774101)
at *2025-10-16 16:20:02.176 UTC*

```txt
Thanks @Luke Forrest (lukeforrest_hashgraph#0 1396895843923005653) , switching the package worked
```
